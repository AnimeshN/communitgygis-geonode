{% extends 'dashboard/base.html' %}
{% load static%}
{% block content %}


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


<style>
	.bs-example{
    	margin: 20px;
    }

    .nav-tabs{
  background-color:#878f89;
}
</style>

<style>
    table, th, td 
        {
            border-bottom: 1px solid #ddd;
            border-collapse: collapse;
            padding: 2px 3px;
            text-align: center;
        }
        th {
            font-weight:bold;
        }
    tr:hover {background-color: #303030;}
    .attri{
  background-color: rgb(245, 255, 238);
  width: 100%;
  text-align: left;
  border-collapse: collapse;
  overflow-y: scroll; 
  height:400px;
    }

    /* tr:nth-child(even) {
  background: rgb(63, 153, 231) 154, 245);
} */
</style>
<style>
    

.info {
    padding: 6px 8px;
    font: 14px/16px Arial, Helvetica, sans-serif;
    background: white;
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
}
.info h4 {
    margin: 0 0 5px;
    color: #777;
}

.legend {
    line-height: 18px;
    color: #555;
}
.legend i {
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
}

/* css to customize Leaflet default styles  */
.leaflet-popup-content-wrapper {
    background: rgba(0, 0, 0, 0.9);
    color: #ffffff;
}

.leaflet-popup-content{
    font-weight: bold;
}

</style>
<!-- <div id="mapdiv" class="col-md-12"></div> -->

<div id="side-bar" style="background-color: rgba(0, 0, 0, 0.2);">                <!-- Main container -->

  <h2 class="text-center">Thakkar Bappa Yojana(Palgarh)</h2>
  <hr>
 <!-- Tab for Report , Dashboard , Query Builder -->
  <div class="bs-example">
    <ul class="nav nav-tabs nav-justified">
        <li class="nav-item">
            <a href="#home" class="nav-link active" data-toggle="tab">Report</a>
        </li>
        <li class="nav-item">
            <a href="#profile" class="nav-link" data-toggle="tab">Dashboard</a>
        </li>
        <li class="nav-item">
            <a href="#messages" class="nav-link" data-toggle="tab">Query Builder</a>
        </li>
    </ul>
    <div class="tab-content">
        <div class="tab-pane fade show active text" id="home">
            <h4 class="mt-2">Report</h4><br>
            
           

             <div class="tooltips" title="Please select the Block">
                <select class = 'form-control' id="block" name="block">
                    <option>Please select block</option>
                     <optgroup label="Jawahar ITDP">
                             <option>Mokhada</option>
                             <option>Jawahar</option>
                             <option>Vada</option>
                             <option>Vikramgarh</option>
                         </optgroup>
                         <optgroup label="Dhanu ITDP">
                             <option>Dhanu</option>
                             <option>Talsari</option>
                             <option>Palgarh</option>
                             <option>Vasai</option>
                         </optgroup>
                </select>
            </div>



             <br>Select Structure:
                <div class="tooltips" title="Please select the structure.">
                    <select class= 'form-control' id="structure" name="structure" placeholder="Enter structure"></select>
                </div>
                <br><br>
               <div class = 'text-center'> 
              <button title="OK" class = 'btn btn-success' onclick="display_layer('OK')"><i class="fa fa-thumbs-up" aria-hidden="true"></i></button>
              <button title="Not OK" class = 'btn btn-success' onclick="display_layer('Not OK')"><i class="fa fa-thumbs-down" aria-hidden="true"></i></button><br><br>

              <button title="Clear layers" class = 'btn btn-success' onclick="clear_layer()"><span class="fa fa-eraser"></span></button>

              <button title="Show Attribute table" class = 'btn btn-success' id="displaytable" ><i class="fa fa-table" aria-hidden="true"></i></button><br><br>
              <button title="Show Attribute table" class = 'btn btn-success' id="downloadtable" >Download</button><br><br>
                </div>
   
        </div>
        <div class="tab-pane fade" id="profile">
            <h4 class="mt-2">Dashboard</h4>
            <p>Dashboard will feature summary of data gathered using charts.</p>
        </div>
        <div class="tab-pane fade" id="messages">
            <h4 class="mt-2">Query Builder</h4>
            <p>User can build queries to analyse data.</p>
        </div>
    </div>
</div>

<!-- Tab ends here -->

 <div style="text-align: center"> 
        <button style="display: inline-block ;position: relative;top: 100px" id="closebutton" name="closebutton" class="btn btn-secondary"><span class="fa fa-power-off"></span></button> 
    </div>
</div>


    <script>


(function() {
   mymap.setView([19.6967, 72.7699],9);

})();

// dependent dropdown
var structures = {
        'Mokhada': ['All','Bitumen Road', 'Concrete Road', 'Culvert','Dug well','Gym','Public water supply (PWS)','Mangal Karyalaya','Borewell','Smashan Bhoomi'],
        'Jawahar': ['All','Borewell','Smashan Bhoomi'],
        'Vada': ['All','Bitumen Road', 'Concrete Road', 'Culvert','Dug well','Gym','Public water supply (PWS)','Mangal Karyalaya','Borewell','Smashan Bhoomi'],
        'Vikramgarh': ['All','Bitumen Road', 'Concrete Road', 'Culvert','Dug well','Gym','Public water supply (PWS)','Mangal Karyalaya','Borewell','Smashan Bhoomi'],
        'Dhanu': ['All','Bitumen Road', 'Concrete Road', 'Culvert','Dug well','Gym','Public water supply (PWS)','Mangal Karyalaya','Borewell','Smashan Bhoomi'],
        'Talsari': ['All','Bitumen Road', 'Concrete Road', 'Culvert','Dug well','Gym','Public water supply (PWS)','Mangal Karyalaya','Borewell','Smashan Bhoomi'],
        'Palgarh': ['All','Bitumen Road', 'Concrete Road', 'Culvert','Dug well','Gym','Public water supply (PWS)','Mangal Karyalaya','Borewell','Smashan Bhoomi'],
        'Vasai': ['All','Bitumen Road', 'Concrete Road', 'Culvert','Dug well','Gym','Public water supply (PWS)','Mangal Karyalaya','Borewell','Smashan Bhoomi'],
    }
  
  var palgarh_block = {'Mokhada':['Mokhada',19.9365, 73.3404],'Jawahar':['Jawhar',19.9077, 73.2355],'Vada':['Vada',19.6570, 73.1409],'Vikramgarh':['Vikramgad',19.7973, 73.0956],'Dhanu':['Dahanu',19.9903, 72.7397],'Talsari':['Talasari',20.1238, 72.9169],'Palgarh':['Palghar',19.6967, 72.7699],'Vasai':['Vasai',19.3919, 72.8397]};
    var $structures = $('#structure');
    $('#block').change(function () {
        var block_pal = document.getElementById('block').value;
        displayPolygon(palgarh_block[block_pal][0],palgarh_block[block_pal][1],palgarh_block[block_pal][2]);
        var block = $(this).val(), lcns = structures[block] || [];
        
        var html = $.map(lcns, function(lcn){
            return '<option value="' + lcn + '">' + lcn + '</option>'
        }).join('');
        $structures.html(html)
    });

    // $('#structure').change(display_layer);

    $("#structure").change({msg: "all"},  function(event) {
    display_layer(event.data.msg);
    
});
    

var myLayerList = [];
    function putLayer(geonode_source){
        console.log('jjj');
        // mymap.setView([19.9365, 73.3404], 11);
        var index = myLayerList.indexOf(geonode_source);
        if(index >= 0){
            console.log('remove'+geonode_source)
            source.getLayer(geonode_source).addTo(mymap).remove(mymap);
            myLayerList.splice(index,1);

        }else{
            console.log('add:::::'+geonode_source);
            // info.toFront(geonode_);
            source.getLayer(geonode_source).addTo(mymap);
            myLayerList.push(geonode_source);
        }
    }





var geojson;

var base_url = "http://localhost/geoserver/geonode/ows?service=WFS&version=1.0.0&request=GetFeature&outputFormat=application/json&";
var info = L.control();
var attribute_table = L.control({position: 'bottomright'});
var layer_name;





const fontAwesomeIcon = L.divIcon({
    html: '<i class="fa fa-map-marker fa-4x"></i>',
    iconSize: [20, 20],
    className: 'myDivIcon'
});


var LayerList = [];
var pointLayerList = [];

function getColor(d) {
    return d > 6 ? '#FF0000' :
           d > 2  ? '#FFFF00' :
           d > -1  ? '#008000' :
                      '#FFEDA0';
}


function getRandomColor() {
  var letters = '0123456789ABCDEF';
  var color = '#';
  for (var i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}

function style(feature) {
    return {
        fillColor: getRandomColor(),
        weight: 5,
        opacity: 1,
        color: 'white',
        fillOpacity: .9
    };
}

function display_layer(assessment){
    // alert(event.data.msg);
    var name_and_icons = fetch_layer_name();
    console.log(name_and_icons[0],name_and_icons[1]);
    displayPoints(name_and_icons[0],name_and_icons[1],assessment);

}

function clear_layer(){
    LayerList.forEach(layer => mymap.removeLayer(layer));
}


function fetch_layer_name(){
    var layer_name,structureIcon;
    var block = document.getElementById('block').value;
    var structure = document.getElementById('structure').value;

    switch(structure){
        case "Culvert":
            layer_name = "ThakkarBappaYojana_Mokhada_Culvert_1_00";
            structureIcon = L.AwesomeMarkers.icon({icon: 'bars', markerColor: 'red', prefix: 'fa' });
            break;
        case "Dug well":
            layer_name = "ThakkarBappaYojana_Mokhada_Well_1_00";
            structureIcon = L.AwesomeMarkers.icon({icon: 'bullseye', markerColor: 'blue', prefix: 'fa' });
            break;

    }




    var name_and_style = [layer_name,structureIcon];
    return name_and_style;

    
}
function displayPoints(layer_name,icon,assessment){
    pointLayerList.forEach(layer => mymap.removeLayer(layer));
// if(mymap.hasLayer(geojson)){
// mymap.removeLayer(geojson);
// }else{
    console.log(layer_name);
mymap.spin(true,{lines: 9, length: 2, width: 20, scale: 60,radius: 70, color: "grey"});
url = base_url + "&typeName=geonode%3A" + layer_name;
fetch(url)
.then(
    function(response) {
    if (response.status !== 200) {
        console.log('Looks like there was a problem. Status Code: ' +
        response.status);
        return;
    }

    // Examine the text in the response
    response.json().then(function(stressData) {
        console.log(stressData.features);

        //attribute table
        // makeAttributeTable(stressData.features);
        // mymap.setView([19.9365, 73.3404], 11);

        geojson = L.geoJson(stressData.features, {
            pointToLayer: function (feature, latlng) {
		return L.marker(latlng, {icon: icon});
	},
    onEachFeature: onEachFeatureForPoint,
    filter: function(feature, layer) {
                if(assessment == 'all'){
                    return true;
                }else{
                    return feature.properties.Final_Asse == assessment;
                    
                }
                
            }
    }).addTo(mymap);
    LayerList.push(geojson);
    pointLayerList.push(geojson);
    mymap.spin(false);
    url = "";

    });


    }
)
.catch(function(err) {
    console.log('Fetch Error :-S', err);
});
// }

    
}



function displayPolygon(blockName,lat,long){
// if(mymap.hasLayer(geojson)){
// mymap.removeLayer(geojson);
// }else{
layer_url =base_url + "&typeName=geonode%3Apalgarh_block&cql_filter=tal_name='"+blockName+"'";
console.log(layer_url);
fetch(layer_url)
.then(
    function(response) {
    if (response.status !== 200) {
        console.log('Looks like there was a problem. Status Code: ' +
        response.status);
        return;
    }

    // Examine the text in the response
    response.json().then(function(geojsonData) {
        // console.log(stressData.features);
        mymap.setView([lat, long], 11);
        geojson = L.geoJson(geojsonData.features, {
        style : style
    }).addTo(mymap);
    LayerList.push(geojson);

    });


    }
)
.catch(function(err) {
    console.log('Fetch Error :-S', err);
});
// }

    
}


// function zoomToFeature(e) {
//     mymap.fitBounds(e.target.getBounds());
// }

function onEachFeatureForPoint(feature, layer) {
	// does this feature have a property named popupContent?
	if (feature.properties && feature.properties.No_of_Pipe) {
		layer.bindPopup("<table class = 'popupclass' ><tr><td>Habitation:</td><td>"+feature.properties.Habitation+"</td></tr>"+
        "<tr><td>Sanction Year:</td><td>"+feature.properties.Sanction_y+"</td></tr>"+
        "<tr><td>Budget:</td><td>"+feature.properties.Budget+"</td></tr>"+
        "<tr><td>Number of pipes:</td><td>"+feature.properties.No_of_Pipe+"</td></tr>"+
        "<tr><td>Width of pipes:</td><td>"+feature.properties.Width+"</tr>"+
        "<tr><td>Final Assessment:</td><td>"+feature.properties.Final_Asse+"</td></tr></table>");

             

        
	}else if(feature.properties && feature.properties.Diameter){
		layer.bindPopup("<table class = 'popupclass ><tr><td>Habitation:</td><td>"+feature.properties.Habitation+"</td></tr>"+
        "<tr><td>Sanction Year:</td><td>"+feature.properties.Sanction_y+"</td></tr>"+
        "<tr><td>Budget:</td><td>"+feature.properties.Budget+"</td></tr>"+
        "<tr><td>Depth:</td><td>"+feature.properties.Depth+"</td></tr>"+
        "<tr><td>Diameter:</td><td>"+feature.properties.Diameter+"</tr>"+
        "<tr><td>Material Used:</td><td>"+feature.properties.Material+"</tr>"+
        "<tr><td>Final Assessment:</td><td>"+feature.properties.Final_Asse+"</td></tr></table>");
    }
}

// function onEachFeature(feature, layer) {
//     layer.on({
//         mouseover: highlightFeature,
//         mouseout: resetHighlight,
//         click: zoomToFeature
//     });
// }
// function highlightFeature(e) {
//     var layer = e.target;

//     layer.setStyle({
//         weight: 5,
//         color: '#666',
//         dashArray: '',
//         fillOpacity: 0.7
        
//     });
//     info.update(layer.feature.properties);
//     if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
//         layer.bringToFront();
//     }
// }

// function resetHighlight(e) {
//     geojson.resetStyle(e.target);
//     info.update();
// }


//  custom control 







var legend = L.control({position: 'bottomright'});



// attribute_table.update = function(mymap){
//     this.div.innerHTML += "hello";
// }



$("#displaytable").click(function(){
attribute_table.onAdd = function(mymap){
var div = L.DomUtil.create('div','attri');
layer_name = fetch_layer_name();
url = base_url + "&typeName=geonode%3A" + layer_name[0];
fetch(url)
.then(
    function(response) {
    if (response.status !== 200) {
        console.log('Looks like there was a problem. Status Code: ' +
        response.status);
        return;
    }

    response.json().then(function(layer) {
        
    var propsJSON = create_property_json(layer.features);
        var col = [];
        for (var i = 0; i < propsJSON.length; i++) {
            for (var key in propsJSON[i]) {
                if (col.indexOf(key) === -1) {
                    col.push(key);
                }
            }
        }

        // CREATE DYNAMIC TABLE.
        var table = document.createElement("table");
        // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

        var tr = table.insertRow(-1);                   // TABLE ROW.

        for (var i = 0; i < col.length; i++) {
            var th = document.createElement("th");      // TABLE HEADER.
            th.innerHTML = col[i];
            tr.appendChild(th);
        }

        // ADD JSON DATA TO THE TABLE AS ROWS.
        for (var i = 0; i < propsJSON.length; i++) {

            tr = table.insertRow(-1);

            for (var j = 0; j < col.length; j++) {
                var tabCell = tr.insertCell(-1);
                tabCell.innerHTML = propsJSON[i][col[j]];
            }
        }

        // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
        // var divContainer = document.getElementById("attri");
        // divContainer.innerHTML = "";
        ctlSidebar.hide();
        div.appendChild(table);

    div.innerHTML += table;
    url = "";
    console.log(table);

    });


    }
)
.catch(function(err) {
    console.log('Fetch Error :-S', err);
});
return div;
}
attribute_table.addTo(mymap);
});

// function createTableFromJSON(myBooks){

         

//         return table;
    

// }

function create_property_json(feature){
    var json_props = [];
    feature.forEach(feat => {
        json_props.push(feat.properties);
    });
    return(json_props);
    
}


</script>


{% endblock %}